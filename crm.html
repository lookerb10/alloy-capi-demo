<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal CRM Forms</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 48px;
        }
        
        .header h1 {
            font-size: 3rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 48px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
        }
        
        .step-circle.active {
            background-color: #3b82f6;
            color: white;
        }
        
        .step-circle.completed {
            background-color: #10b981;
            color: white;
        }
        
        .step-circle.inactive {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        
        .step-line {
            width: 48px;
            height: 2px;
            background-color: #e5e7eb;
        }
        
        .step-line.completed {
            background-color: #10b981;
        }
        
        .step-title {
            font-weight: 500;
            color: #374151;
        }
        
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        
        .action-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 16px;
        }
        
        .action-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }
        
        .action-icon {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 32px;
            color: white;
        }
        
        .action-icon.contacts { background-color: #3b82f6; }
        .action-icon.deals { background-color: #10b981; }
        .action-icon.companies { background-color: #8b5cf6; }
        
        .action-title {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }
        
        .action-description {
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .crm-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 16px;
        }
        
        .crm-card:hover {
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
            transform: translateY(-1px);
        }
        
        .crm-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .crm-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6b7280;
            flex-shrink: 0;
        }
        
        .crm-info {
            flex: 1;
        }
        
        .crm-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .crm-description {
            font-size: 14px;
            color: #6b7280;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .required::after {
            content: "*";
            color: #dc2626;
            margin-left: 4px;
        }
        
        .field-hint {
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
        }
        
        .field-hint code {
            background-color: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: Monaco, 'Courier New', monospace;
        }
        
        .grid {
            display: grid;
            gap: 24px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        
        .section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .required-indicator {
            width: 8px;
            height: 8px;
            background-color: #dc2626;
            border-radius: 50%;
        }
        
        .optional-indicator {
            width: 8px;
            height: 8px;
            background-color: #6b7280;
            border-radius: 50%;
        }
        
        .preview-box {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .preview-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 12px;
        }
        
        .preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 14px;
        }
        
        .preview-field {
            background-color: #dbeafe;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: Monaco, 'Courier New', monospace;
            color: #1e40af;
        }
        
        .mapping-box {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
        }
        
        .mapping-title {
            font-size: 12px;
            font-weight: 500;
            color: #166534;
            margin-bottom: 8px;
        }
        
        .mapping-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #166534;
            margin-bottom: 4px;
        }
        
        .mapping-item code {
            background-color: #dcfce7;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: Monaco, 'Courier New', monospace;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 48px;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        
        .alert-success {
            background-color: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .alert-error {
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .alert-warning {
            background-color: #fefce8;
            color: #ca8a04;
            border: 1px solid #fef08a;
        }
        
        .hidden { display: none; }
        
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mt-4 { margin-top: 16px; }
        .mt-6 { margin-top: 24px; }
        
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-4 { gap: 16px; }
        
        .execution-summary {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .success-icon {
            width: 64px;
            height: 64px;
            background-color: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 32px;
            color: white;
        }
        
        .execute-icon {
            width: 64px;
            height: 64px;
            background-color: #f59e0b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 32px;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Universal CRM Forms</h1>
            <p>One form, any CRM platform - powered by unified field mapping</p>
        </div>

        <!-- Configuration Step -->
        <div id="config-step" class="card" style="display: block;">
            <div class="text-center mb-6">
                <h2 style="font-size: 2rem; margin-bottom: 8px;">Universal CRM Forms Configuration</h2>
                <p style="color: #6b7280;">Enter your Alloy API credentials to get started</p>
            </div>

            <div id="config-validation" class="alert alert-error hidden mb-4">
                <strong>Configuration Required</strong>
                <p>Please enter both your API Key and User ID to use the Universal CRM Forms.</p>
                <p>You can find these in your Alloy dashboard under Settings > API Keys.</p>
            </div>

            <div style="max-width: 500px; margin: 0 auto;">
                <div class="form-group">
                    <label class="form-label">Alloy API Key</label>
                    <input 
                        type="password" 
                        id="api-key-input" 
                        class="form-input" 
                        placeholder="Enter your Alloy API key"
                    />
                    <div class="field-hint">
                        Find this in your Alloy dashboard: Settings → API Keys
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">User ID</label>
                    <input 
                        type="text" 
                        id="user-id-input" 
                        class="form-input" 
                        placeholder="Enter your Alloy User ID"
                    />
                    <div class="field-hint">
                        The user ID for which CRM records will be created
                    </div>
                </div>

                <div class="text-center mt-6">
                    <button class="btn btn-primary" onclick="validateAndStart()">
                        Start Universal CRM Forms →
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Steps (initially hidden) -->
        <div class="progress hidden" id="progress-bar">
            <div class="step">
                <div class="step-circle active" id="step-1">1</div>
                <div class="step-title">Choose Action</div>
            </div>
            <div class="step-line" id="line-1"></div>
            <div class="step">
                <div class="step-circle inactive" id="step-2">2</div>
                <div class="step-title">Fill Universal Form</div>
            </div>
            <div class="step-line" id="line-2"></div>
            <div class="step">
                <div class="step-circle inactive" id="step-3">3</div>
                <div class="step-title">Select CRM</div>
            </div>
            <div class="step-line" id="line-3"></div>
            <div class="step">
                <div class="step-circle inactive" id="step-4">4</div>
                <div class="step-title">Execute</div>
            </div>
            <div class="step-line" id="line-4"></div>
            <div class="step">
                <div class="step-circle inactive" id="step-5">5</div>
                <div class="step-title">Success</div>
            </div>
        </div>

        <!-- Step 1: Action Selection -->
        <div id="action-step" class="card hidden">
            <div class="text-center mb-6">
                <h2 style="font-size: 2rem; margin-bottom: 8px;">What would you like to create?</h2>
                <p style="color: #6b7280;">Choose the type of record you want to add to your CRM</p>
            </div>
            
            <div class="grid grid-3">
                <div class="action-card" onclick="selectAction('create_contact')">
                    <div class="action-icon contacts">👤</div>
                    <div class="action-title">Create Contact</div>
                    <div class="action-description">Add a new person to your CRM</div>
                    <div style="color: #3b82f6;">→</div>
                </div>

                <div class="action-card" onclick="selectAction('create_deal')">
                    <div class="action-icon deals">💰</div>
                    <div class="action-title">Create Deal</div>
                    <div class="action-description">Add a new sales opportunity</div>
                    <div style="color: #10b981;">→</div>
                </div>

                <div class="action-card" onclick="selectAction('create_company')">
                    <div class="action-icon companies">🏢</div>
                    <div class="action-title">Create Company</div>
                    <div class="action-description">Add a new organization to your CRM</div>
                    <div style="color: #8b5cf6;">→</div>
                </div>
            </div>
        </div>

        <!-- Step 2: Universal Form -->
        <div id="form-step" class="card hidden">
            <div class="text-center mb-6">
                <div id="form-icon" class="action-icon" style="margin: 0 auto 16px;"></div>
                <h2 id="form-title" style="font-size: 2rem; margin-bottom: 8px;"></h2>
                <p style="color: #6b7280;">Fill out the form below with universal field names that work across all CRM platforms</p>
            </div>

            <div id="form-content">
                <!-- Form fields will be dynamically generated here -->
            </div>

            <div class="flex justify-between items-center mt-6" style="padding-top: 24px; border-top: 1px solid #e5e7eb;">
                <button class="btn btn-secondary" onclick="goToStep(1)">← Back to Actions</button>
                <button class="btn btn-primary" onclick="validateAndContinue()">Continue to CRM Selection →</button>
            </div>
        </div>

        <!-- Step 3: CRM Selection -->
        <div id="crm-step" class="card hidden">
            <div class="text-center mb-6">
                <h2 style="font-size: 2rem; margin-bottom: 8px;">Choose Your CRM Platform</h2>
                <p style="color: #6b7280;">Your universal form data will be mapped to the selected CRM's field format</p>
            </div>

            <div id="form-preview" class="preview-box">
                <div class="preview-title">Form Data Preview:</div>
                <div id="preview-content"></div>
            </div>

            <div id="loading-crms" class="loading">
                <div class="spinner"></div>
            </div>

            <div id="crm-list" class="hidden">
                <!-- CRM options will be loaded here -->
            </div>

            <div class="text-center mt-6">
                <button class="btn btn-secondary" onclick="goToStep(2)">← Back to Form</button>
            </div>
        </div>

        <!-- Step 4: Execution -->
        <div id="execute-step" class="card hidden">
            <div class="text-center">
                <div class="execute-icon" id="execute-icon">
                    <span id="execute-icon-content">→</span>
                </div>
                
                <h2 style="font-size: 2rem; margin-bottom: 8px;">Ready to Execute</h2>
                <p style="color: #6b7280;" id="execute-description">
                    Create record in selected CRM
                </p>

                <div class="execution-summary">
                    <h4 style="font-weight: 600; color: #111827; margin-bottom: 16px;">Execution Summary:</h4>
                    <div id="execution-details"></div>
                </div>

                <div class="flex justify-center gap-4">
                    <button class="btn btn-secondary" onclick="goToStep(3)" id="back-to-crm-btn">← Back to CRM Selection</button>
                    <button class="btn btn-success" onclick="executeAction()" id="execute-btn">✓ Execute Action</button>
                </div>
            </div>
        </div>

        <!-- Step 5: Success -->
        <div id="success-step" class="card hidden">
            <div class="text-center">
                <div class="success-icon">✓</div>
                
                <h2 style="font-size: 2rem; margin-bottom: 8px;">Successfully Created!</h2>
                <p style="color: #6b7280;" id="success-description">
                    Your record has been created successfully
                </p>

                <div id="success-details" class="mapping-box text-left">
                    <div class="mapping-title">Mapped Data:</div>
                    <div id="mapped-data"></div>
                </div>

                <button class="btn btn-primary" onclick="resetDemo()">Create Another Record</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - will be set by user
        let CONFIG = {
            apiKey: '',
            userId: '',
            baseUrl: 'https://production.runalloy.com'
        };

        // Global state
        let currentStep = 1;
        let selectedAction = null;
        let formData = {};
        let selectedCRM = null;
        let availableCRMs = [];

        // Universal actions configuration
        const universalActions = {
            'create_contact': {
                name: 'Create Contact',
                description: 'Add a new person to your CRM',
                icon: '👤',
                color: 'contacts',
                fields: {
                    required: [
                        { name: 'contact_email', label: 'Email Address', type: 'email', placeholder: 'john.doe@company.com' },
                        { name: 'contact_first_name', label: 'First Name', type: 'text', placeholder: 'John' },
                        { name: 'contact_last_name', label: 'Last Name', type: 'text', placeholder: 'Doe' }
                    ],
                    optional: [
                        { name: 'contact_phone', label: 'Phone Number', type: 'tel', placeholder: '+1 (555) 123-4567' },
                        { name: 'contact_company', label: 'Company Name', type: 'text', placeholder: 'Acme Corp' },
                        { name: 'contact_title', label: 'Job Title', type: 'text', placeholder: 'Sales Manager' },
                        { name: 'contact_website', label: 'Website', type: 'url', placeholder: 'https://company.com' },
                        { name: 'contact_address_street', label: 'Street Address', type: 'text', placeholder: '123 Main St' },
                        { name: 'contact_address_city', label: 'City', type: 'text', placeholder: 'New York' },
                        { name: 'contact_address_state', label: 'State/Province', type: 'text', placeholder: 'NY' },
                        { name: 'contact_address_postal', label: 'Postal Code', type: 'text', placeholder: '10001' },
                        { name: 'contact_address_country', label: 'Country', type: 'text', placeholder: 'United States' }
                    ]
                }
            },
            'create_deal': {
                name: 'Create Deal',
                description: 'Add a new sales opportunity',
                icon: '💰',
                color: 'deals',
                fields: {
                    required: [
                        { name: 'deal_name', label: 'Deal Name', type: 'text', placeholder: 'Q1 Enterprise Deal' },
                        { name: 'deal_amount', label: 'Deal Amount', type: 'number', placeholder: '50000' },
                        { name: 'deal_stage', label: 'Deal Stage', type: 'select', options: [
                            { value: 'prospecting', label: 'Prospecting' },
                            { value: 'qualification', label: 'Qualification' },
                            { value: 'proposal', label: 'Proposal' },
                            { value: 'negotiation', label: 'Negotiation' },
                            { value: 'closed-won', label: 'Closed Won' },
                            { value: 'closed-lost', label: 'Closed Lost' }
                        ]}
                    ],
                    optional: [
                        { name: 'deal_close_date', label: 'Expected Close Date', type: 'date' },
                        { name: 'deal_probability', label: 'Probability (%)', type: 'number', placeholder: '75', min: '0', max: '100' },
                        { name: 'deal_description', label: 'Description', type: 'textarea', placeholder: 'Deal details and notes...' },
                        { name: 'deal_type', label: 'Deal Type', type: 'select', options: [
                            { value: 'new-business', label: 'New Business' },
                            { value: 'existing-customer', label: 'Existing Customer' },
                            { value: 'renewal', label: 'Renewal' }
                        ]}
                    ]
                }
            },
            'create_company': {
                name: 'Create Company',
                description: 'Add a new organization to your CRM',
                icon: '🏢',
                color: 'companies',
                fields: {
                    required: [
                        { name: 'company_name', label: 'Company Name', type: 'text', placeholder: 'Acme Corporation' }
                    ],
                    optional: [
                        { name: 'company_website', label: 'Website', type: 'url', placeholder: 'https://acme.com' },
                        { name: 'company_phone', label: 'Phone Number', type: 'tel', placeholder: '+1 (555) 123-4567' },
                        { name: 'company_industry', label: 'Industry', type: 'select', options: [
                            { value: 'technology', label: 'Technology' },
                            { value: 'healthcare', label: 'Healthcare' },
                            { value: 'finance', label: 'Finance' },
                            { value: 'manufacturing', label: 'Manufacturing' },
                            { value: 'retail', label: 'Retail' },
                            { value: 'education', label: 'Education' },
                            { value: 'other', label: 'Other' }
                        ]},
                        { name: 'company_employees', label: 'Number of Employees', type: 'select', options: [
                            { value: '1-10', label: '1-10' },
                            { value: '11-50', label: '11-50' },
                            { value: '51-200', label: '51-200' },
                            { value: '201-1000', label: '201-1000' },
                            { value: '1000+', label: '1000+' }
                        ]},
                        { name: 'company_revenue', label: 'Annual Revenue', type: 'number', placeholder: '1000000' },
                        { name: 'company_address_street', label: 'Street Address', type: 'text', placeholder: '123 Business Blvd' },
                        { name: 'company_address_city', label: 'City', type: 'text', placeholder: 'San Francisco' },
                        { name: 'company_address_state', label: 'State/Province', type: 'text', placeholder: 'CA' },
                        { name: 'company_address_postal', label: 'Postal Code', type: 'text', placeholder: '94105' },
                        { name: 'company_address_country', label: 'Country', type: 'text', placeholder: 'United States' },
                        { name: 'company_description', label: 'Description', type: 'textarea', placeholder: 'Company description...' }
                    ]
                }
            }
        };

        // CRM field mappings
        const crmFieldMappings = {
            'hubspot': {
                'contact_email': 'email',
                'contact_first_name': 'firstname',
                'contact_last_name': 'lastname',
                'contact_phone': 'phone',
                'contact_company': 'company',
                'contact_title': 'jobtitle',
                'contact_website': 'website',
                'contact_address_city': 'city',
                'contact_address_postal': 'zip',
                'contact_address_street': 'address',
                'contact_address_state': 'state',
                'contact_address_country': 'country',
                'deal_name': 'dealname',
                'deal_amount': 'amount',
                'deal_stage': 'dealstage',
                'deal_close_date': 'closedate',
                'deal_probability': 'deal_probability',
                'company_name': 'name',
                'company_website': 'website',
                'company_phone': 'phone'
            },
            'salesforce': {
                'contact_email': 'Email',
                'contact_first_name': 'FirstName',
                'contact_last_name': 'LastName',
                'contact_phone': 'Phone',
                'contact_company': 'Company',
                'contact_title': 'Title',
                'deal_name': 'Name',
                'deal_amount': 'Amount',
                'deal_stage': 'StageName',
                'deal_close_date': 'CloseDate',
                'company_name': 'Name',
                'company_website': 'Website',
                'company_phone': 'Phone'
            },
            'copper': {
                'contact_email': 'emails',
                'contact_first_name': 'name',
                'contact_last_name': 'name',
                'contact_phone': 'phone_numbers',
                'contact_company': 'company_name',
                'deal_name': 'name',
                'deal_amount': 'monetary_value',
                'company_name': 'name'
            }
        };

        // CRM action mappings
        const crmActionMappings = {
            'create_contact': {
                'hubspot': 'createContact',
                'salesforce': 'createContact', 
                'copper': 'createPerson'
            },
            'create_deal': {
                'hubspot': 'createDeal',
                'salesforce': 'createOpportunity',
                'copper': 'createOpportunity'
            },
            'create_company': {
                'hubspot': 'createCompany',
                'salesforce': 'createAccount',
                'copper': 'createCompany'
            }
        };

        // Configuration validation
        function validateConfiguration() {
            return CONFIG.apiKey && CONFIG.userId;
        }

        // API function with configuration validation
        async function makeAlloyApiCall(endpoint, method = 'GET', body = null, includeUserId = true) {
            if (!validateConfiguration()) {
                throw new Error('API configuration required');
            }
            
            try {
                console.log(`🚀 API Call: ${method} ${CONFIG.baseUrl}${endpoint}`);
                
                const headers = {
                    'Authorization': `Bearer ${CONFIG.apiKey}`,
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'x-api-version': '2025-06',
                };
                
                if (includeUserId && CONFIG.userId) {
                    headers['x-alloy-userid'] = CONFIG.userId;
                }
                
                console.log('📤 Headers:', headers);
                
                const response = await fetch(`${CONFIG.baseUrl}${endpoint}`, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null,
                });

                console.log(`📥 Status: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`❌ Error: ${errorText}`);
                    throw new Error(`${response.status} ${response.statusText}: ${errorText}`);
                }

                const responseData = await response.json();
                console.log(`✅ Success:`, responseData);
                return responseData;
            } catch (error) {
                console.error('❌ API Error:', error);
                throw error;
            }
        }

        // Step management
        function updateStepIndicator(step) {
            for (let i = 1; i <= 5; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                const lineEl = document.getElementById(`line-${i}`);
                
                if (i < step) {
                    stepEl.className = 'step-circle completed';
                    stepEl.textContent = '✓';
                    if (lineEl) lineEl.className = 'step-line completed';
                } else if (i === step) {
                    stepEl.className = 'step-circle active';
                    stepEl.textContent = i;
                    if (lineEl) lineEl.className = 'step-line';
                } else {
                    stepEl.className = 'step-circle inactive';
                    stepEl.textContent = i;
                    if (lineEl) lineEl.className = 'step-line';
                }
            }
        }

        function goToStep(step) {
            const steps = ['action-step', 'form-step', 'crm-step', 'execute-step', 'success-step'];
            
            steps.forEach(stepId => {
                document.getElementById(stepId).classList.add('hidden');
            });
            
            document.getElementById(steps[step - 1]).classList.remove('hidden');
            currentStep = step;
            updateStepIndicator(step);
        }

        // Action selection
        function selectAction(actionId) {
            selectedAction = universalActions[actionId];
            selectedAction.id = actionId;
            console.log('Selected action:', selectedAction);
            
            // Update form step UI
            const formIcon = document.getElementById('form-icon');
            formIcon.innerHTML = selectedAction.icon;
            formIcon.className = `action-icon ${selectedAction.color}`;
            
            document.getElementById('form-title').textContent = selectedAction.name;
            
            generateForm();
            goToStep(2);
        }

        // Form generation
        function generateForm() {
            const formContent = document.getElementById('form-content');
            formContent.innerHTML = '';
            
            // Required fields section
            const requiredSection = document.createElement('div');
            requiredSection.className = 'section';
            requiredSection.innerHTML = `
                <div class="section-title">
                    <div class="required-indicator"></div>
                    Required Fields
                </div>
            `;
            
            const requiredGrid = document.createElement('div');
            requiredGrid.className = 'grid grid-2';
            
            selectedAction.fields.required.forEach(field => {
                requiredGrid.appendChild(createFieldElement(field, true));
            });
            
            requiredSection.appendChild(requiredGrid);
            formContent.appendChild(requiredSection);
            
            // Optional fields section
            const optionalSection = document.createElement('div');
            optionalSection.className = 'section';
            optionalSection.innerHTML = `
                <div class="section-title">
                    <div class="optional-indicator"></div>
                    Optional Fields
                </div>
            `;
            
            const optionalGrid = document.createElement('div');
            optionalGrid.className = 'grid grid-2';
            
            selectedAction.fields.optional.forEach(field => {
                optionalGrid.appendChild(createFieldElement(field, false));
            });
            
            optionalSection.appendChild(optionalGrid);
            formContent.appendChild(optionalSection);
        }

        function createFieldElement(field, isRequired) {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            
            const label = document.createElement('label');
            label.className = `form-label ${isRequired ? 'required' : ''}`;
            label.textContent = field.label;
            
            let input;
            if (field.type === 'select') {
                input = document.createElement('select');
                input.className = 'form-select';
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `Select ${field.label}`;
                input.appendChild(defaultOption);
                
                if (field.options) {
                    field.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        input.appendChild(opt);
                    });
                }
            } else if (field.type === 'textarea') {
                input = document.createElement('textarea');
                input.className = 'form-textarea';
                if (field.placeholder) input.placeholder = field.placeholder;
            } else {
                input = document.createElement('input');
                input.className = 'form-input';
                input.type = field.type;
                if (field.placeholder) input.placeholder = field.placeholder;
                if (field.min) input.min = field.min;
                if (field.max) input.max = field.max;
            }
            
            input.addEventListener('change', (e) => {
                formData[field.name] = e.target.value;
                updateFormPreview();
            });
            
            input.addEventListener('input', (e) => {
                formData[field.name] = e.target.value;
                updateFormPreview();
            });
            
            const hint = document.createElement('div');
            hint.className = 'field-hint';
            hint.innerHTML = `Universal field: <code>${field.name}</code>`;
            
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            formGroup.appendChild(hint);
            
            return formGroup;
        }

        function updateFormPreview() {
            const previewContent = document.getElementById('preview-content');
            if (!previewContent) return;
            
            previewContent.innerHTML = '';
            
            Object.entries(formData).filter(([key, value]) => value).forEach(([key, value]) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <code class="preview-field">${key}:</code>
                    <span>${value}</span>
                `;
                previewContent.appendChild(previewItem);
            });
        }

        function validateAndContinue() {
            // Validate required fields
            const requiredFields = selectedAction.fields.required;
            const missingFields = requiredFields.filter(field => !formData[field.name]);
            
            if (missingFields.length > 0) {
                alert(`Please fill in required fields: ${missingFields.map(f => f.label).join(', ')}`);
                return;
            }
            
            loadCRMs();
            goToStep(3);
        }

        // CRM loading
        async function loadCRMs() {
            try {
                document.getElementById('loading-crms').classList.remove('hidden');
                document.getElementById('crm-list').classList.add('hidden');
                
                const connectorsResponse = await makeAlloyApiCall('/connectors', 'GET', null, false);
                console.log('Raw connectors response:', connectorsResponse);
                
                let connectors = [];

                if (connectorsResponse.connectors && Array.isArray(connectorsResponse.connectors)) {
                    connectors = connectorsResponse.connectors;
                } else if (Array.isArray(connectorsResponse)) {
                    connectors = connectorsResponse;
                } else {
                    console.warn('Connectors data not found in expected structure:', connectorsResponse);
                }

                console.log('🔍 Inspecting connectors:');
                connectors.forEach(connector => {
                    console.log(`Connector: ${connector.name || connector.id}`, connector.categories);
                });

                // Filter for CRM connectors - check category array for "crm"
                const crmConnectors = connectors.filter(connector => {
                    const categories = connector.category;

                    if (!Array.isArray(categories)) {
                        console.warn(`⚠️ No category array for ${connector.name || connector.id}`);
                        return false;
                    }

                    const isCRM = categories.some(category =>
                        typeof category === 'string' && category.toLowerCase().includes('crm')
                    );

                    if (isCRM) {
                        console.log(`✅ Found CRM: ${connector.name || connector.id} [${categories.join(', ')}]`);
                    }

                    return isCRM;
                });
                
                console.log(`Found ${crmConnectors.length} CRM connectors:`, crmConnectors);
                availableCRMs = crmConnectors;
                displayCRMs(crmConnectors);
                
            } catch (error) {
                console.error('Failed to load CRMs:', error);
                // Fallback to demo CRMs
                const fallbackCRMs = [
                    { id: 'hubspot', name: 'hubspot', displayName: 'HubSpot', description: 'Marketing & Sales CRM' },
                    { id: 'salesforce', name: 'salesforce', displayName: 'Salesforce', description: 'Enterprise CRM Platform' },
                    { id: 'copper', name: 'copper', displayName: 'Copper', description: 'Google Workspace CRM' }
                ];
                availableCRMs = fallbackCRMs;
                displayCRMs(fallbackCRMs);
            } finally {
                document.getElementById('loading-crms').classList.add('hidden');
            }
        }

        function displayCRMs(crms) {
            const crmList = document.getElementById('crm-list');
            crmList.innerHTML = '';
            
            crms.forEach(crm => {
                const crmCard = document.createElement('div');
                crmCard.className = 'crm-card';
                crmCard.onclick = () => selectCRM(crm);
                
                const mappingPreview = generateMappingPreview(crm);
                
                crmCard.innerHTML = `
                    <div class="crm-header">
                        <div class="crm-icon">
                            ${crm.icon ? `<img src="${crm.icon}" alt="${crm.displayName || crm.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` : 
                              (crm.displayName || crm.name || '?').charAt(0).toUpperCase()}
                        </div>
                        <div class="crm-info">
                            <div class="crm-name">${crm.displayName || crm.name}</div>
                            <div class="crm-description">${crm.description || 'CRM Platform'}</div>
                        </div>
                        <div style="color: #10b981; font-size: 18px;">→</div>
                    </div>
                    ${mappingPreview}
                `;
                
                crmList.appendChild(crmCard);
            });
            
            crmList.classList.remove('hidden');
        }

        function generateMappingPreview(crm) {
            const mapping = crmFieldMappings[crm.name] || {};
            const filledFields = Object.keys(formData).filter(key => formData[key]);
            const previewFields = filledFields.slice(0, 3);
            
            if (previewFields.length === 0) return '';
            
            const mappingItems = previewFields.map(field => {
                const mappedField = mapping[field] || field;
                return `
                    <div class="mapping-item">
                        <code>${field}</code> → <code>${mappedField}</code>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="mapping-box">
                    <div class="mapping-title">Fields will be mapped to:</div>
                    ${mappingItems}
                </div>
            `;
        }

        function selectCRM(crm) {
            selectedCRM = crm;
            console.log('Selected CRM:', selectedCRM);
            
            setupExecution();
            goToStep(4);
        }

        // Execution setup
        function setupExecution() {
            document.getElementById('execute-description').textContent = 
                `Create ${selectedAction.name.toLowerCase()} in ${selectedCRM.displayName || selectedCRM.name}`;
            
            const executionDetails = document.getElementById('execution-details');
            executionDetails.innerHTML = `
                <div class="summary-item">
                    <span style="color: #6b7280;">Action:</span>
                    <span style="font-weight: 500;">${selectedAction.name}</span>
                </div>
                <div class="summary-item">
                    <span style="color: #6b7280;">Target CRM:</span>
                    <span style="font-weight: 500;">${selectedCRM.displayName || selectedCRM.name}</span>
                </div>
                <div class="summary-item">
                    <span style="color: #6b7280;">Fields to create:</span>
                    <span style="font-weight: 500;">${Object.keys(formData).filter(k => formData[k]).length}</span>
                </div>
            `;
        }

        // Execution
        async function executeAction() {
            try {
                const executeBtn = document.getElementById('execute-btn');
                const backBtn = document.getElementById('back-to-crm-btn');
                const executeIcon = document.getElementById('execute-icon-content');
                
                // Show loading state
                executeBtn.disabled = true;
                backBtn.disabled = true;
                executeBtn.innerHTML = '<div style="width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div> Executing...';
                executeIcon.innerHTML = '<div style="width: 24px; height: 24px; border: 3px solid #ffffff; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>';
                
                console.log('🚀 Starting execution...');
                console.log('Form data:', formData);
                console.log('Selected CRM:', selectedCRM.name.toLowerCase());  // <-- changed line

                console.log('Selected action:', selectedAction.id);
                
                // Map universal fields to CRM-specific fields
                const mappedData = mapFieldsForCRM(formData, selectedCRM.name.toLowerCase());  // changed
                
                console.log('Mapped data:', mappedData);
                
                // Get credentials
                console.log('🔐 Getting credentials...');
                // Original:
                // const credResponse = await makeAlloyApiCall(`/connectors/${selectedCRM.name}/credentials`, 'GET', null, true);
                // Changed:
                const credResponse = await makeAlloyApiCall(`/connectors/${selectedCRM.name.toLowerCase()}/credentials`, 'GET', null, true);
                
                const credentials = credResponse.credentials || credResponse.data || credResponse || [];
                
                if (!Array.isArray(credentials) || credentials.length === 0) {
                    throw new Error(`No credentials configured for ${selectedCRM.displayName}. Please authenticate in your Alloy dashboard.`);
                }
                
                const credential = credentials[0];
                console.log('✅ Using credential:', credential.credentialId || credential.id);
                
                // Get the correct action ID
                // Original:
                // const actionId = crmActionMappings[selectedAction.id]?.[selectedCRM.name] || 'create';
                // Changed:
                const actionId = crmActionMappings[selectedAction.id]?.[selectedCRM.name.toLowerCase()] || 'create';
                
                console.log('📋 Using action ID:', actionId);
                
                // Execute the action
                console.log('⚡ Executing action...');
                // Original:
                // const result = await makeAlloyApiCall(`/connectors/${selectedCRM.name}/actions/${actionId}/execute`, 'POST', {
                // Changed:
                const result = await makeAlloyApiCall(`/connectors/${selectedCRM.name.toLowerCase()}/actions/${actionId}/execute`, 'POST', {
                    credentialId: credential.credentialId || credential.id,
                    requestBody: {
                        properties: mappedData
                    },
                    additionalHeaders: {},
                    queryParameters: {},
                    pathParams: {}
                }, true);
                
                console.log('✅ Execution successful:', result);
                
                // Show success
                showSuccess(mappedData);
                goToStep(5);
                
            } catch (error) {
                console.error('❌ Execution failed:', error);
                
                // Reset buttons
                const executeBtn = document.getElementById('execute-btn');
                const backBtn = document.getElementById('back-to-crm-btn');
                const executeIcon = document.getElementById('execute-icon-content');
                
                executeBtn.disabled = false;
                backBtn.disabled = false;
                executeBtn.innerHTML = '✓ Execute Action';
                executeIcon.textContent = '→';
                
                // Show error
                let errorMessage = error.message;
                if (errorMessage.includes('No credentials')) {
                    errorMessage += '\n\nTo fix this:\n1. Go to your Alloy dashboard\n2. Set up authentication for ' + selectedCRM.displayName + '\n3. Try again';
                }
                
                alert(`Error: ${errorMessage}`);
            }
        }


        function mapFieldsForCRM(universalData, crmName) {
            const mapping = crmFieldMappings[crmName] || {};
            const mappedData = {};

            Object.entries(universalData).forEach(([key, value]) => {
                if (value) { // Only include fields with values
                    const mappedKey = mapping[key] || key;
                    mappedData[mappedKey] = value;
                }
            });

            return mappedData;
        }

        // Success display
        function showSuccess(mappedData) {
            document.getElementById('success-description').textContent = 
                `Your ${selectedAction.name.toLowerCase()} has been created in ${selectedCRM.displayName || selectedCRM.name}`;
            
            const mappedDataDiv = document.getElementById('mapped-data');
            mappedDataDiv.innerHTML = '';
            
            Object.entries(mappedData).forEach(([key, value]) => {
                const mappingItem = document.createElement('div');
                mappingItem.className = 'mapping-item';
                mappingItem.innerHTML = `
                    <code>${key}:</code>
                    <span>${value}</span>
                `;
                mappedDataDiv.appendChild(mappingItem);
            });
        }

        // Reset demo
        function resetDemo() {
            currentStep = 1;
            selectedAction = null;
            formData = {};
            selectedCRM = null;
            availableCRMs = [];
            
            // Clear form
            document.getElementById('form-content').innerHTML = '';
            document.getElementById('preview-content').innerHTML = '';
            
            goToStep(1);
        }

        // Configuration and initialization functions
        function validateAndStart() {
            console.log('validateAndStart() called');
            const apiKey = document.getElementById('api-key-input').value.trim();
            const userId = document.getElementById('user-id-input').value.trim();
            
            if (!apiKey || !userId) {
                const validation = document.getElementById('config-validation');
                validation.classList.remove('hidden');
                return;
            }
            
            // Set CONFIG values
            CONFIG.apiKey = apiKey;
            CONFIG.userId = userId;
            
            console.log('Configuration set:', {apiKey: apiKey.substring(0,10) + '...', userId});
            
            // Hide config and show main interface
            document.getElementById('config-step').classList.add('hidden');
            document.getElementById('progress-bar').classList.remove('hidden');
            document.getElementById('action-step').classList.remove('hidden');
            
            // Initialize the main app
            updateStepIndicator(1);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Universal CRM Forms initialized');
            updateStepIndicator(1);
            updateFormPreview();
        });
    </script>
</body>
</html>